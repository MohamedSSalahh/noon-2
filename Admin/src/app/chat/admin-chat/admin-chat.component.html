<div class="flex h-screen bg-gray-100">
  <!-- Sidebar: Conversation List -->
  <div class="w-1/3 bg-white border-r flex flex-col">
    <div class="p-4 border-b bg-gradient-to-r from-blue-600 to-blue-700">
      <h2 class="text-xl font-bold text-white">ðŸ’¬ Chat Conversations</h2>
      <p class="text-sm text-blue-100 mt-1">{{ conversations.length }} conversation(s)</p>
    </div>
    
    <!-- Loading State -->
    <div *ngIf="loading" class="flex items-center justify-center p-8">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
    </div>
    
    <!-- Conversations List -->
    <ul *ngIf="!loading" class="overflow-y-auto flex-1">
      <li *ngFor="let conv of conversations" 
          (click)="selectConversation(conv)"
          class="p-4 border-b hover:bg-blue-50 cursor-pointer transition-colors"
          [class.bg-blue-100]="selectedConversation?._id === conv._id"
          [class.border-l-4]="selectedConversation?._id === conv._id"
          [class.border-blue-600]="selectedConversation?._id === conv._id">
        <div class="flex items-center">
          <!-- User Avatar -->
          <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white font-bold text-lg mr-3">
            {{ getParticipantName(conv).charAt(0).toUpperCase() }}
          </div>
          <div class="flex-1 min-w-0">
            <p class="font-semibold text-gray-900 truncate">{{ getParticipantName(conv) }}</p>
            <p class="text-sm text-gray-500 truncate">
              {{ conv.lastMessage?.text || 'No messages yet' }}
            </p>
            <p class="text-xs text-gray-400 mt-1">
              {{ conv.updatedAt | date:'short' }}
            </p>
          </div>
        </div>
      </li>
      
      <!-- Empty State -->
      <li *ngIf="conversations.length === 0" class="p-8 text-center text-gray-400">
        <p>No conversations yet</p>
        <p class="text-sm mt-2">Conversations will appear here when users message you</p>
      </li>
    </ul>
  </div>

  <!-- Chat Area -->
  <div class="w-2/3 flex flex-col" *ngIf="selectedConversation; else noSelection">
    <!-- Chat Header -->
    <div class="p-4 border-b bg-white shadow-sm">
      <div class="flex items-center">
        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white font-bold mr-3">
          {{ getParticipantName(selectedConversation).charAt(0).toUpperCase() }}
        </div>
        <div>
          <h3 class="font-bold text-gray-900">{{ getParticipantName(selectedConversation) }}</h3>
          <p class="text-sm text-gray-500">User Chat</p>
        </div>
      </div>
    </div>

    <!-- Locked Banner -->
    <div *ngIf="isLockedForMe" class="bg-red-50 border-b border-red-200 p-2 text-center text-red-700 text-sm font-medium">
        ðŸ”’ This conversation is currently being handled by a Manager.
    </div>

    <!-- Messages Container -->
    <div #messagesContainer class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
      <!-- Loading Messages -->
      <div *ngIf="loadingMessages" class="flex items-center justify-center p-8">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
      </div>
      
      <!-- Messages -->
      <div *ngFor="let msg of messages" 
           [class.text-right]="(msg.sender?._id || msg.sender) === adminId"
           [class.text-left]="(msg.sender?._id || msg.sender) !== adminId"
           class="group flex items-start gap-2"
           [class.flex-row-reverse]="(msg.sender?._id || msg.sender) === adminId"
           [class.justify-start]="(msg.sender?._id || msg.sender) !== adminId">
           
        <div class="max-w-[70%]">
          <div class="inline-block px-4 py-2 rounded-lg shadow-sm relative group"
               [class.bg-blue-600]="(msg.sender?._id || msg.sender) === adminId"
               [class.text-white]="(msg.sender?._id || msg.sender) === adminId"
               [class.bg-white]="(msg.sender?._id || msg.sender) !== adminId"
               [class.text-gray-800]="(msg.sender?._id || msg.sender) !== adminId">
            <p class="break-words">{{ msg.text }}</p>
            
            <!-- Manager Actions -->
             <div *ngIf="isManager" class="absolute -top-3 right-0 opacity-0 group-hover:opacity-100 transition-opacity bg-white shadow-md rounded-full p-1 flex items-center border">
                <button (click)="editMessage(msg)" class="p-1 hover:bg-gray-100 rounded-full text-blue-600" title="Edit">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                </button>
                <button (click)="deleteMessage(msg._id)" class="p-1 hover:bg-gray-100 rounded-full text-red-600" title="Delete">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </button>
             </div>
          </div>
          <div class="text-xs mt-1 px-1"
               [class.text-gray-500]="(msg.sender?._id || msg.sender) === adminId"
               [class.text-gray-400]="(msg.sender?._id || msg.sender) !== adminId">
            {{ msg.createdAt | date:'short' }}
            <span *ngIf="msg.updatedAt !== msg.createdAt" class="items-center text-xs text-gray-400 ml-1">(edited)</span>
          </div>
        </div>
      </div>
      
      <!-- Typing Indicator -->
      <div *ngIf="isTyping" class="flex justify-start">
        <div class="bg-white px-4 py-2 rounded-lg shadow-sm">
          <div class="flex space-x-1">
            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0s"></div>
            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
          </div>
        </div>
      </div>
      
      <!-- Empty Messages State -->
      <div *ngIf="!loadingMessages && messages.length === 0" class="flex items-center justify-center h-full text-gray-400">
        <div class="text-center">
          <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
          </svg>
          <p>No messages yet</p>
          <p class="text-sm mt-2">Start the conversation!</p>
        </div>
      </div>
    </div>

    <!-- Input Area -->
    <div class="p-4 border-t bg-white" [class.opacity-50]="isLockedForMe" [class.pointer-events-none]="isLockedForMe">
      <div class="flex space-x-2">
        <input 
          [(ngModel)]="newMessage" 
          (keyup.enter)="sendMessage()"
          (input)="onTyping()"
          [disabled]="isLockedForMe"
          type="text" 
          class="flex-1 border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          [placeholder]="isLockedForMe ? 'Locked by Manager' : 'Type your message...'"
        />
        <button 
          (click)="sendMessage()"
          [disabled]="!newMessage.trim() || isLockedForMe"
          class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors font-medium shadow-sm">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- No Selection State -->
  <ng-template #noSelection>
    <div class="w-2/3 flex items-center justify-center bg-gray-50">
      <div class="text-center text-gray-400">
        <svg class="w-24 h-24 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
        </svg>
        <p class="text-xl font-medium">Select a conversation to start chatting</p>
        <p class="text-sm mt-2">Choose a user from the list on the left</p>
      </div>
    </div>
  </ng-template>
</div>
